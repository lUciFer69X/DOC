import React, { useState, useEffect, useMemo } from 'react';
import { 
  Search, 
  Pill, 
  GraduationCap, 
  HeartPulse, 
  Microscope, 
  Calculator, 
  Syringe, 
  StickyNote, 
  Save, 
  ChevronLeft, 
  AlertTriangle, 
  Baby, 
  Weight, 
  Calendar,
  X,
  Stethoscope,
  Activity,
  Droplets,
  Thermometer,
  Info
} from 'lucide-react';

// --- ูุงุนุฏุฉ ุงูุจูุงูุงุช (The Brain) ---

const DRUG_DB = [
  { name: "Panadol / Abimol", generic: "Paracetamol", use: "ูุณูู ููุฃูู ูุฎุงูุถ ููุญุฑุงุฑุฉ (ุขูู ููุญูุงูู)", dose: "ูุฑุต 500ูุฌู / 6-8 ุณุงุนุงุช", warn: "ุขูู ุฌุฏุงูุ ูููู ูุง ุชุชุฌุงูุฒู 4 ุฌู ููููุงู.", type: "otc" },
  { name: "Cataflam / Voltaren", generic: "Diclofenac Pot/Sod", use: "ูุณูู ููู ููุถุงุฏ ููุงูุชูุงุจ (ุนุธุงู/ุฃุณูุงู)", dose: "50 ูุฌู / 8-12 ุณุงุนุฉ", warn: "ููููุน ููุฑุถู ูุฑุญุฉ ุงููุนุฏุฉุ ุงููููุ ูุงูุถุบุท ุงูุนุงูู.", type: "nsaid" },
  { name: "Brufen", generic: "Ibuprofen", use: "ูุณูู ููุถุงุฏ ุงูุชูุงุจ ูุฎุงูุถ ุญุฑุงุฑุฉ ููุฃุทูุงู", dose: "400 ูุฌู / 8 ุณุงุนุงุช", warn: "ูุคุฎุฐ ุจุนุฏ ุงูุฃูู ูุชุฌูุจ ุฃูู ุงููุนุฏุฉ.", type: "nsaid" },
  { name: "Augmentin / Hibiotic", generic: "Amoxicillin + Clavulanic", use: "ูุถุงุฏ ุญููู ูุงุณุน ุงููุฌุงู (ุชููุณู/ูุณุงูู)", dose: "1 ุฌู / 12 ุณุงุนุฉ", warn: "ูุฏ ูุณุจุจ ุฅุณูุงู. ููููุน ููู ูุฏููู ุญุณุงุณูุฉ ุจููุณููู.", type: "antibiotic" },
  { name: "Zithromax / Zisrocin", generic: "Azithromycin", use: "ูุถุงุฏ ุญููู (ุชููุณู ุนููู/ููุฑููุง)", dose: "500 ูุฌู ูุฑุฉ ูุงุญุฏุฉ ููููุงู (3 ุฃูุงู)", warn: "ูุคุฎุฐ ูุจู ุงูุฃูู ุจุณุงุนุฉ ุฃู ุจุนุฏู ุจุณุงุนุชูู.", type: "antibiotic" },
  { name: "Flagyl / Amrizole", generic: "Metronidazole", use: "ูุทูุฑ ูุนูู (ููุฅุณูุงู ูุงูุฃููุจุง)", dose: "500 ูุฌู / 8 ุณุงุนุงุช", warn: "ูุณุจุจ ุทุนู ูุนุฏูู ุจุงููู ูุชููู ุงูุจูู.", type: "antibiotic" },
  { name: "Antodine / Famotin", generic: "Famotidine", use: "ููุญููุถุฉ ูุงุฑุชุฌุงุน ุงููุฑูุก", dose: "40 ูุฌู ูุณุงุกู", warn: "ุขูู ูุณุจูุงู.", type: "git" },
  { name: "Controloc / Zurcal", generic: "Pantoprazole", use: "ููุฑุญุฉ ุงููุนุฏุฉ ูุงูุงุฑุชุฌุงุน ุงูุดุฏูุฏ", dose: "40 ูุฌู ูุจู ุงููุทุงุฑ ุจูุตู ุณุงุนุฉ", warn: "ูุณุชุฎุฏู ููุชุฑุงุช ุทูููุฉ ุจุฃูุงู.", type: "git" },
  { name: "Visceralgine", generic: "Tiemonium", use: "ูููุบุต ูุงูุชููุตุงุช (ุงูุฏูุฑุฉ/ุงูููููู)", dose: "ูุฑุต 3 ูุฑุงุช ุนูุฏ ุงููุฒูู", warn: "ูุฏ ูุณุจุจ ุฌูุงู ุจุงููู.", type: "spasm" },
  { name: "Neuril / Valinil", generic: "Diazepam", use: "ููุฏุฆ ููุถุงุฏ ููุชุดูุฌุงุช (ุทูุงุฑุฆ)", dose: "ูุฑูุฏ ุจุจุทุก ุดุฏูุฏ ุฌุฏุงู", warn: "โ๏ธ ุฌุฏูู ูุฎุฏุฑุงุช! ูุฏ ูุณุจุจ ุชููู ุงูุชููุณ (Apnea).", type: "cns" },
  { name: "Lasix", generic: "Furosemide", use: "ูุฏุฑ ููุจูู (ุถุบุท ุนุงูู/ุชูุฑู)", dose: "40 ูุฌู ุตุจุงุญุงู", warn: "ูููู ุงูุจูุชุงุณููู ููุณุจุจ ูุซุฑุฉ ุงูุชุจูู.", type: "cvs" },
  { name: "Capoten", generic: "Captopril", use: "ุทูุงุฑุฆ ุงูุถุบุท ุงููุฑุชูุน (ุชุญุช ุงููุณุงู)", dose: "25 ูุฌู ุนูุฏ ุงููุฒูู", warn: "ูุณุจุจ ูุญุฉ ูุงุดูุฉ.", type: "cvs" },
  { name: "Adrenaline", generic: "Epinephrine", use: "ุฅูุนุงุด ุงูููุจ / ุตุฏูุฉ ุงูุญุณุงุณูุฉ", dose: "ุฃูุจูู (ุทูุงุฑุฆ ููุท)", warn: "ูุณุจุจ ุชุณุงุฑุน ุดุฏูุฏ ูู ุงูููุจ.", type: "emergency" },
  { name: "Plavix", generic: "Clopidogrel", use: "ุณูููุฉ ุงูุฏู (ููููุจ ูุงูุฌูุทุงุช)", dose: "75 ูุฌู ููููุงู", warn: "ุฎุทุฑ ุงููุฒููุ ูููู ูุจู ุงูุนูููุงุช.", type: "cvs" },
  { name: "Concor", generic: "Bisoprolol", use: "ุชูุธูู ุถุฑุจุงุช ุงูููุจ ูุงูุถุบุท", dose: "2.5 - 10 ูุฌู ุตุจุงุญุงู", warn: "โ๏ธ ุฎุทุฑ ุฌุฏุงู ุฅููุงูู ูุฌุฃุฉ.", type: "cvs" }
];

const TERMINOLOGY = [
  { term: "-itis", meaning: "ุงูุชูุงุจ (Inflammation)" },
  { term: "Hyper-", meaning: "ุนุงูู / ุฒูุงุฏุฉ (High)" },
  { term: "Hypo-", meaning: "ููุฎูุถ (Low)" },
  { term: "Tachy-", meaning: "ุณุฑูุน (Fast)" },
  { term: "Brady-", meaning: "ุจุทูุก (Slow)" },
  { term: "Dys-", meaning: "ุตุนูุจุฉ / ุฎูู (Difficulty)" }
];

const SUFFIXES = [
  { term: "-lol", meaning: "Beta Blockers (ููุถุบุท ูุงูููุจ)" },
  { term: "-pril", meaning: "ACE Inhibitors (ููุถุบุท)" },
  { term: "-sartan", meaning: "ARBs (ููุถุบุท)" },
  { term: "-prazole", meaning: "Proton Pump Inhibitors (ูููุนุฏุฉ)" },
  { term: "-statin", meaning: "Cholesterol drugs (ููุฏููู)" },
  { term: "-cillin", meaning: "Penicillins (ูุถุงุฏ ุญููู)" },
  { term: "-floxacin", meaning: "Quinolones (ูุถุงุฏ ุญููู)" }
];

// --- ููููุงุช ูุงุฌูุฉ ุงููุณุชุฎุฏู (UI Components) ---

const SectionTitle = ({ icon: Icon, title, color = "text-purple-600" }) => (
  <div className="flex items-center gap-3 mb-6 px-2">
    <div className={`p-2 rounded-lg bg-opacity-10 ${color.replace('text-', 'bg-')}`}>
      <Icon size={24} className={color} />
    </div>
    <h2 className="text-xl font-bold text-slate-800">{title}</h2>
  </div>
);

const Card = ({ children, className = "", onClick }) => (
  <div 
    onClick={onClick}
    className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-5 transition-all duration-200 ${onClick ? 'cursor-pointer hover:shadow-md hover:scale-[1.01] active:scale-[0.98]' : ''} ${className}`}
  >
    {children}
  </div>
);

const Badge = ({ children, type }) => {
  const colors = {
    otc: "bg-green-100 text-green-700",
    nsaid: "bg-orange-100 text-orange-700",
    antibiotic: "bg-blue-100 text-blue-700",
    emergency: "bg-red-100 text-red-700",
    git: "bg-yellow-100 text-yellow-700",
    cvs: "bg-pink-100 text-pink-700",
    default: "bg-slate-100 text-slate-700"
  };
  return (
    <span className={`px-2.5 py-1 rounded-md text-xs font-bold ${colors[type] || colors.default}`}>
      {children}
    </span>
  );
};

// --- ุงูุชุทุจูู ุงูุฑุฆูุณู ---

export default function DrBiboApp() {
  const [activeTab, setActiveTab] = useState('home'); 
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedDrug, setSelectedDrug] = useState(null);
  const [notes, setNotes] = useState('');
  const [showSaveMsg, setShowSaveMsg] = useState(false);

  // States for Calculators
  const [calcPed, setCalcPed] = useState({ w: '', d: '', c: '', res: null });
  const [calcBMI, setCalcBMI] = useState({ w: '', h: '', res: null, status: '' });
  const [calcEDD, setCalcEDD] = useState({ lmp: '', res: null });

  // ุชุญููู ุงูููุงุญุธุงุช ุนูุฏ ุงููุชุญ
  useEffect(() => {
    const saved = localStorage.getItem('bibo_notes');
    if (saved) setNotes(saved);
  }, []);

  const handleSaveNotes = () => {
    localStorage.setItem('bibo_notes', notes);
    setShowSaveMsg(true);
    setTimeout(() => setShowSaveMsg(false), 3000);
  };

  const filteredDrugs = useMemo(() => {
    if (!searchQuery) return DRUG_DB;
    const q = searchQuery.toLowerCase();
    return DRUG_DB.filter(d => 
      d.name.toLowerCase().includes(q) || 
      d.generic.toLowerCase().includes(q) || 
      d.use.includes(q)
    );
  }, [searchQuery]);

  // ุงูุชุญููู ุงูุชููุงุฆู ูุชุจููุจ ุงูุฃุฏููุฉ ุนูุฏ ุงูุจุญุซ
  useEffect(() => {
    if (searchQuery && activeTab !== 'drugs') {
      setActiveTab('drugs');
    }
  }, [searchQuery]);

  const renderContent = () => {
    switch (activeTab) {
      case 'drugs':
        return (
          <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <SectionTitle icon={Pill} title="ุฏููู ุงูุฃุฏููุฉ (Pharmacology)" color="text-purple-600" />
            {filteredDrugs.length === 0 ? (
              <div className="text-center py-12 text-slate-400">
                <Search size={48} className="mx-auto mb-4 opacity-20" />
                <p>ูููุด ุฏูุงุก ุจุงูุงุณู ุฏู ูุง ุฏูุชูุฑุฉ ๐คทโโ๏ธ</p>
              </div>
            ) : (
              filteredDrugs.map((drug, idx) => (
                <Card key={idx} onClick={() => setSelectedDrug(drug)} className="border-r-4 border-r-purple-500">
                  <div className="flex justify-between items-center">
                    <div>
                      <h3 className="font-bold text-lg text-purple-900">{drug.name}</h3>
                      <p className="text-sm text-slate-500 font-medium mb-2">{drug.generic}</p>
                      <Badge type={drug.type || 'default'}>{drug.use.split(' ')[0]}</Badge>
                    </div>
                    <ChevronLeft className="text-slate-300" />
                  </div>
                  <div className="mt-2 text-xs text-slate-400 truncate max-w-[250px]">
                    {drug.use}
                  </div>
                </Card>
              ))
            )}
          </div>
        );

      case 'study':
        return (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <SectionTitle icon={GraduationCap} title="ุงููุฑุฌุน ุงูุฏุฑุงุณู (Study)" color="text-blue-600" />
            
            <Card>
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Activity size={18} className="text-blue-500" /> ูุตุทูุญุงุช ุทุจูุฉ
              </h3>
              <div className="overflow-hidden rounded-xl border border-slate-100">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="p-3 text-right">ุงููุตุทูุญ</th>
                      <th className="p-3 text-right">ุงููุนูู</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {TERMINOLOGY.map((t, i) => (
                      <tr key={i}>
                        <td className="p-3 font-semibold text-blue-700 dir-ltr text-left">{t.term}</td>
                        <td className="p-3 text-slate-600">{t.meaning}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </Card>

            <Card>
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Pill size={18} className="text-purple-500" /> ููุงุชูุญ ุงูุฃุฏููุฉ
              </h3>
              <ul className="space-y-3">
                {SUFFIXES.map((s, i) => (
                  <li key={i} className="flex items-center gap-3 text-sm p-2 bg-slate-50 rounded-lg">
                    <span className="font-bold text-purple-600 dir-ltr min-w-[80px] text-center">{s.term}</span>
                    <span className="text-slate-600">{s.meaning}</span>
                  </li>
                ))}
              </ul>
            </Card>

             <Card>
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <StickyNote size={18} className="text-slate-500" /> ุงุฎุชุตุงุฑุงุช ุงูุฑูุดุชุฉ
              </h3>
              <div className="grid grid-cols-2 gap-2 text-sm">
                 <div className="bg-slate-50 p-2 rounded"><b>OD:</b> ูุฑุฉ ููููุงู</div>
                 <div className="bg-slate-50 p-2 rounded"><b>BID:</b> ูุฑุชูู ููููุงู</div>
                 <div className="bg-slate-50 p-2 rounded"><b>TID:</b> 3 ูุฑุงุช ููููุงู</div>
                 <div className="bg-slate-50 p-2 rounded"><b>PO:</b> ุจุงููู</div>
                 <div className="bg-slate-50 p-2 rounded"><b>IV:</b> ูุฑูุฏ</div>
                 <div className="bg-slate-50 p-2 rounded"><b>IM:</b> ุนุถู</div>
              </div>
            </Card>
          </div>
        );

      case 'emergency':
        return (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <SectionTitle icon={HeartPulse} title="ุจุฑูุชููููุงุช ุงูุทูุงุฑุฆ" color="text-red-600" />
            
            <div className="bg-white rounded-2xl shadow-sm border border-red-100 overflow-hidden">
              <div className="bg-red-600 text-white p-4 font-bold flex items-center gap-2">
                <HeartPulse size={20} /> ุชููู ุงูููุจ (CPR)
              </div>
              <div className="p-5 text-slate-700 space-y-2 text-sm">
                <p>1. ุชุฃูุฏู ูู ุงูุฃูุงู ุซู ุงููุนู.</p>
                <p>2. ุงุชุตูู ุจุงูุฅุณุนุงู / Code Blue.</p>
                <p>3. ุชุญุณุณู ุงููุจุถ ุงูุณุจุงุชู ููุฏุฉ 10 ุซูุงู.</p>
                <div className="font-bold text-red-600 bg-red-50 p-2 rounded border border-red-100 text-center">
                  ูุง ููุฌุฏ ูุจุถุ ุงุจุฏุฃู ุงูุถุบุทุงุช ููุฑุงู
                </div>
                <ul className="list-disc list-inside pr-2 text-slate-600 mt-2">
                  <li>ูุนุฏู: 100-120 ุถุบุทุฉ/ุฏูููุฉ.</li>
                  <li>ุนูู: 5-6 ุณู.</li>
                  <li>ูุณุจุฉ 30 ุถุบุทุฉ : 2 ููุณ.</li>
                </ul>
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-sm border border-amber-100 overflow-hidden">
              <div className="bg-amber-500 text-white p-4 font-bold flex items-center gap-2">
                <AlertTriangle size={20} /> ุตุฏูุฉ ุงูุญุณุงุณูุฉ (Anaphylaxis)
              </div>
              <div className="p-5">
                <p className="text-sm text-slate-600 mb-4">
                  <b>โ๏ธ ุงูุฃุนุฑุงุถ:</b> ุชูุฑู ุดูุงููุ ุถูู ุชููุณุ ุทูุญ ุฌูุฏูุ ูุจูุท ุถุบุท.
                </p>
                <div className="space-y-2 bg-amber-50 p-3 rounded-xl border border-amber-100">
                  <p className="text-amber-800 font-bold text-sm">ุงูุนูุงุฌ ุงูููุฑู:</p>
                  <ol className="list-decimal list-inside text-sm text-slate-700 space-y-1">
                    <li><span className="font-bold">Adrenaline:</span> ุฃูุจูู ุนุถู ููุฑุงู (ุจุฏูู ุชุฎููู).</li>
                    <li><span className="font-bold">Avil:</span> ุฃูุจูู ูุฑูุฏ/ุนุถู.</li>
                    <li><span className="font-bold">Solu-Cortef:</span> 100mg ูุฑูุฏ ุจุจุทุก.</li>
                  </ol>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-sm border border-purple-100 overflow-hidden">
              <div className="bg-purple-600 text-white p-4 font-bold flex items-center gap-2">
                 <Activity size={20} /> ุงูุชุดูุฌุงุช (Seizures)
              </div>
              <div className="p-5 text-sm text-slate-700">
                <p className="mb-2">1. ุงูุฃูุงู (ุงุจุนุฏู ุฃู ุญุงุฌุฉ ุญุงุฏุฉ).</p>
                <p className="mb-2">2. ุถุนู ุงููุฑูุถ ุนูู ุฌูุจู (Recovery Pos).</p>
                <hr className="my-3"/>
                <p><b>๐ ุงูุนูุงุฌ:</b> Diazepam (Neuril) ูุฑูุฏ ุจุจุทุก ุดุฏูุฏ.</p>
              </div>
            </div>
          </div>
        );

      case 'labs':
        return (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <SectionTitle icon={Microscope} title="ุงูููู ุงูุทุจูุนูุฉ (Labs)" color="text-teal-600" />
            
            {[
              { title: "ุตูุฑุฉ ุงูุฏู (CBC)", icon: Activity, color: "text-red-500", data: [
                { k: "WBCs", v: "4k - 11k" }, { k: "Hb (Male)", v: "13.5 - 17.5" }, { k: "Hb (Female)", v: "12.0 - 15.5" }, { k: "PLT", v: "150k - 450k" }
              ]},
              { title: "ูุธุงุฆู ููู ููุจุฏ", icon: Thermometer, color: "text-orange-500", data: [
                { k: "Creatinine", v: "0.6 - 1.2" }, { k: "Urea", v: "15 - 45" }, { k: "ALT/AST", v: "Up to 40" }
              ]},
              { title: "ุงูุดูุงุฑุฏ (Electrolytes)", icon: Activity, color: "text-yellow-500", data: [
                { k: "Sodium (Na)", v: "135 - 145" }, { k: "Potassium (K)", v: "3.5 - 5.0" }, { k: "Calcium", v: "8.5 - 10.2" }
              ]}
            ].map((section, i) => (
              <Card key={i}>
                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                  <section.icon size={18} className={section.color} /> {section.title}
                </h3>
                <div className="grid grid-cols-2 gap-3">
                  {section.data.map((item, idx) => (
                    <div key={idx} className="bg-slate-50 p-2 rounded-lg text-center border border-slate-100">
                      <div className="text-xs text-slate-400 font-bold uppercase">{item.k}</div>
                      <div className="font-mono text-slate-700 font-semibold dir-ltr">{item.v}</div>
                    </div>
                  ))}
                </div>
              </Card>
            ))}
          </div>
        );

      case 'calcs':
        return (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <SectionTitle icon={Calculator} title="ุญุงุณุจุงุช ุทุจูุฉ" color="text-indigo-600" />
            
            {/* Pediatric Dose */}
            <Card>
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Baby size={20} className="text-pink-500" /> ุฌุฑุนุฉ ุดุฑุงุจ ููุฃุทูุงู
              </h3>
              <div className="space-y-3">
                <input type="number" placeholder="ูุฒู ุงูุทูู (ูุฌู)" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:border-indigo-500 focus:outline-none" onChange={e => setCalcPed({...calcPed, w: e.target.value})} />
                <div className="flex gap-3">
                  <input type="number" placeholder="ุงูุฌุฑุนุฉ (mg/kg)" className="w-1/2 p-3 bg-slate-50 rounded-xl border border-slate-200" onChange={e => setCalcPed({...calcPed, d: e.target.value})} />
                  <input type="number" placeholder="ุงูุชุฑููุฒ (mg/5ml)" className="w-1/2 p-3 bg-slate-50 rounded-xl border border-slate-200" onChange={e => setCalcPed({...calcPed, c: e.target.value})} />
                </div>
                <button 
                  onClick={() => {
                    const res = (parseFloat(calcPed.w) * parseFloat(calcPed.d) * 5) / parseFloat(calcPed.c);
                    setCalcPed({...calcPed, res: isNaN(res) ? null : res.toFixed(1)});
                  }}
                  className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200"
                >
                  ุงุญุณุจ ุงูุฌุฑุนุฉ
                </button>
                {calcPed.res && (
                  <div className="bg-green-100 text-green-800 p-3 rounded-xl text-center font-bold border border-green-200">
                    ุงูุฌุฑุนุฉ: {calcPed.res} ุณู <span className="text-xs font-normal">ูู ูุฑุฉ</span>
                  </div>
                )}
              </div>
            </Card>

            {/* BMI */}
            <Card>
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Weight size={20} className="text-teal-500" /> ูุคุดุฑ ูุชูุฉ ุงูุฌุณู (BMI)
              </h3>
              <div className="flex gap-3 mb-3">
                <input type="number" placeholder="ุงููุฒู (ูุฌู)" className="w-1/2 p-3 bg-slate-50 rounded-xl border border-slate-200" onChange={e => setCalcBMI({...calcBMI, w: e.target.value})} />
                <input type="number" placeholder="ุงูุทูู (ุณู)" className="w-1/2 p-3 bg-slate-50 rounded-xl border border-slate-200" onChange={e => setCalcBMI({...calcBMI, h: e.target.value})} />
              </div>
              <button 
                onClick={() => {
                  const hM = parseFloat(calcBMI.h) / 100;
                  const bmi = parseFloat(calcBMI.w) / (hM * hM);
                  let status = "";
                  if(bmi < 18.5) status = "ูุญุงูุฉ";
                  else if(bmi < 25) status = "ูุฒู ูุซุงูู";
                  else if(bmi < 30) status = "ูุฒู ุฒุงุฆุฏ";
                  else status = "ุณููุฉ";
                  setCalcBMI({...calcBMI, res: isNaN(bmi) ? null : bmi.toFixed(1), status});
                }}
                className="w-full py-3 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 transition shadow-lg shadow-teal-200"
              >
                ุงุญุณุจ BMI
              </button>
              {calcBMI.res && (
                <div className="mt-3 bg-slate-800 text-white p-3 rounded-xl text-center">
                  <div className="text-2xl font-bold">{calcBMI.res}</div>
                  <div className="text-sm opacity-80">{calcBMI.status}</div>
                </div>
              )}
            </Card>

             {/* Pregnancy EDD */}
             <Card>
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Calendar size={20} className="text-amber-500" /> ููุนุฏ ุงูููุงุฏุฉ (EDD)
              </h3>
              <div className="space-y-3">
                <label className="text-sm text-slate-500">ุฃูู ููู ูู ุขุฎุฑ ุฏูุฑุฉ:</label>
                <input type="date" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200" onChange={e => setCalcEDD({...calcEDD, lmp: e.target.value})} />
                
                <button 
                  onClick={() => {
                    const lmpDate = new Date(calcEDD.lmp);
                    if(!isNaN(lmpDate.getTime())) {
                        lmpDate.setDate(lmpDate.getDate() + 7);
                        lmpDate.setMonth(lmpDate.getMonth() + 9);
                        setCalcEDD({...calcEDD, res: lmpDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })});
                    }
                  }}
                  className="w-full py-3 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600 transition shadow-lg shadow-amber-200"
                >
                  ุงุญุณุจ ุงูููุนุฏ
                </button>
                {calcEDD.res && (
                  <div className="bg-amber-100 text-amber-900 p-3 rounded-xl text-center font-bold border border-amber-200">
                    {calcEDD.res}
                  </div>
                )}
              </div>
            </Card>
          </div>
        );

      case 'nursing':
        return (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <SectionTitle icon={Syringe} title="ููุงุฑุงุช ุงูุชูุฑูุถ" color="text-sky-600" />
            
            <Card>
              <h3 className="font-bold text-slate-800 mb-4 text-center">ุฏููู ุฃููุงู ุงููุงููููุง</h3>
              <div className="grid grid-cols-3 gap-3">
                {[
                  { c: "bg-yellow-400 text-black", t: "Yellow", g: "24G" },
                  { c: "bg-blue-500 text-white", t: "Blue", g: "22G" },
                  { c: "bg-pink-500 text-white", t: "Pink", g: "20G" },
                  { c: "bg-green-500 text-white", t: "Green", g: "18G" },
                  { c: "bg-gray-400 text-white", t: "Grey", g: "16G" },
                  { c: "bg-orange-500 text-white", t: "Orange", g: "14G" },
                ].map((can, i) => (
                  <div key={i} className={`${can.c} p-3 rounded-xl text-center shadow-sm`}>
                    <div className="font-bold text-sm">{can.t}</div>
                    <div className="text-xs opacity-90">{can.g}</div>
                  </div>
                ))}
              </div>
            </Card>

            <Card>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                <Droplets size={20} className="text-sky-500" /> ุฃููุงุน ุงููุญุงููู
              </h3>
              <div className="space-y-3 text-sm">
                <div className="p-3 bg-sky-50 rounded-lg border border-sky-100">
                  <span className="font-bold text-sky-700 block mb-1">Isotonic (ูุชุนุงุฏู)</span>
                  <span className="text-slate-600">N.Saline 0.9% / Ringer: ูุฑูุน ุงูุถุบุทุ ุงูุฌูุงูุ ุงูุนูููุงุช.</span>
                </div>
                <div className="p-3 bg-blue-50 rounded-lg border border-blue-100">
                  <span className="font-bold text-blue-700 block mb-1">Hypotonic (ูุฎูู)</span>
                  <span className="text-slate-600">Glucose 5%: ููุฌูุงู ุงูุฎููู (Hypernatremia).</span>
                </div>
                <div className="p-3 bg-red-50 rounded-lg border border-red-100">
                  <span className="font-bold text-red-700 block mb-1">Hypertonic (ูุฑูุฒ)</span>
                  <span className="text-slate-600">Mannitol: ูุณุญุจ ุงูููุงู ูู ุงููุฎ (Edema).</span>
                </div>
              </div>
            </Card>
          </div>
        );

      case 'notes':
        return (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <SectionTitle icon={StickyNote} title="ููุช ุจูู ุงูุฏูุชูุฑุฉ" color="text-slate-600" />
            
            <div className="relative">
              <textarea 
                className="w-full h-64 p-4 rounded-2xl border-2 border-slate-200 focus:border-purple-500 focus:outline-none resize-none bg-yellow-50 text-slate-700 leading-relaxed shadow-inner"
                placeholder="ุงูุชุจู ููุงุญุธุงุชู ููุง... (ูุชุชุญูุธ ุชููุงุฆู)"
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
              />
            </div>
            
            <button 
              onClick={handleSaveNotes}
              className="w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold text-lg shadow-lg hover:bg-emerald-700 transition flex items-center justify-center gap-2"
            >
              <Save size={20} /> ุญูุธ ุงูููุงุญุธุงุช
            </button>
            
            {showSaveMsg && (
              <div className="text-center text-emerald-600 font-bold animate-pulse bg-emerald-50 p-2 rounded-lg border border-emerald-100">
                ุชู ุงูุญูุธ ุจูุฌุงุญ! โ
              </div>
            )}
          </div>
        );

      default: // Home
        return (
          <div className="grid grid-cols-2 gap-4 animate-in fade-in zoom-in duration-300 pb-20">
            {[
              { id: 'drugs', label: 'ุฃุฏููุฉ', icon: Pill, color: 'text-purple-600', bg: 'bg-purple-50' },
              { id: 'study', label: 'ุฏุฑุงุณุฉ', icon: GraduationCap, color: 'text-blue-600', bg: 'bg-blue-50' },
              { id: 'emergency', label: 'ุทูุงุฑุฆ', icon: HeartPulse, color: 'text-red-600', bg: 'bg-red-50' },
              { id: 'labs', label: 'ุชุญุงููู', icon: Microscope, color: 'text-teal-600', bg: 'bg-teal-50' },
              { id: 'calcs', label: 'ุญุงุณุจุงุช', icon: Calculator, color: 'text-indigo-600', bg: 'bg-indigo-50' },
              { id: 'nursing', label: 'ุชูุฑูุถ', icon: Syringe, color: 'text-sky-600', bg: 'bg-sky-50' },
              { id: 'notes', label: 'ููุงุญุธุงุชู', icon: StickyNote, color: 'text-slate-600', bg: 'bg-slate-50' },
            ].map((cat) => (
              <div 
                key={cat.id}
                onClick={() => setActiveTab(cat.id)}
                className={`flex flex-col items-center justify-center p-6 rounded-3xl shadow-sm border border-slate-100 cursor-pointer transition-all hover:scale-105 active:scale-95 bg-white ${cat.id === 'notes' ? 'col-span-2' : ''}`}
              >
                <div className={`p-4 rounded-full mb-3 ${cat.bg}`}>
                  <cat.icon size={32} className={cat.color} />
                </div>
                <span className="text-base font-bold text-slate-700">{cat.label}</span>
              </div>
            ))}
          </div>
        );
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans dir-rtl text-slate-800 pb-24" dir="rtl">
      {/* ุงูููุฏุฑ ุงูุฑุฆูุณู */}
      <div className="relative bg-gradient-to-br from-purple-700 to-indigo-800 text-white rounded-b-[2.5rem] shadow-xl overflow-hidden pb-10">
        <div className="relative px-6 pt-12 pb-8 text-center">
          <h1 className="text-3xl font-extrabold mb-2 tracking-tight">Dr. Bibo Universe โพ๏ธ</h1>
          <p className="text-purple-200 text-sm font-medium">ูู ุณูุฉ ูุงูุชู ุทูุจุฉ ูุง ุฏูุชูุฑุฉ ุงููุณุชูุจู โค๏ธ</p>
        </div>
      </div>

      {/* ุดุฑูุท ุงูุจุญุซ ุงูุนุงุฆู */}
      <div className="px-6 -mt-8 relative z-10 mb-6">
        <div className="relative shadow-xl rounded-full bg-white">
          <input 
            type="text" 
            placeholder="๐ ุงุจุญุซู ุนู ุฏูุงุกุ ุนุฑุถุ ุฃู ุชุญููู..." 
            className="w-full py-4 pr-14 pl-6 rounded-full border-none focus:ring-4 focus:ring-purple-200 outline-none text-slate-700 font-medium transition-all placeholder-slate-400"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
          <div className="absolute top-1/2 right-4 -translate-y-1/2 text-purple-600">
            {searchQuery ? (
              <X className="cursor-pointer hover:bg-slate-100 rounded-full p-1" onClick={() => setSearchQuery('')} />
            ) : null}
          </div>
        </div>
      </div>

      {/* ููุทูุฉ ุงููุญุชูู ุงูุฑุฆูุณูุฉ */}
      <div className="px-4 max-w-2xl mx-auto">
        {activeTab !== 'home' && (
          <button 
            onClick={() => setActiveTab('home')}
            className="mb-4 text-sm text-slate-500 flex items-center gap-1 hover:text-purple-600 transition-colors font-medium"
          >
            <ChevronLeft size={16} /> ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
          </button>
        )}
        {renderContent()}
      </div>

      {/* ุดุฑูุท ุงูุชููู ุงูุณููู */}
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 shadow-[0_-5px_30px_rgba(0,0,0,0.08)] rounded-t-3xl z-50 px-4 py-2">
        <div className="flex justify-between items-center max-w-md mx-auto relative">
          {[
            { id: 'drugs', icon: Pill, label: 'ุฃุฏููุฉ' },
            { id: 'nursing', icon: Syringe, label: 'ุชูุฑูุถ' },
            { id: 'home', icon: Stethoscope, label: 'ุงูุฑุฆูุณูุฉ', main: true },
            { id: 'calcs', icon: Calculator, label: 'ุญุงุณุจุฉ' },
            { id: 'emergency', icon: HeartPulse, label: 'ุทูุงุฑุฆ' },
          ].map((item) => (
            <button
              key={item.id}
              onClick={() => {
                setActiveTab(item.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }}
              className={`flex flex-col items-center justify-center transition-all duration-300 ${
                activeTab === item.id ? 'text-purple-600' : 'text-slate-400 hover:text-slate-600'
              } ${item.main ? 'relative -top-8' : 'w-16'}`}
            >
              <div className={`${item.main ? 'bg-purple-600 text-white p-4 rounded-full shadow-lg shadow-purple-300 ring-4 ring-white' : ''} ${activeTab === item.id && !item.main ? '-translate-y-1' : ''} transition-transform`}>
                 <item.icon size={item.main ? 28 : 24} strokeWidth={2.5} />
              </div>
              {!item.main && <span className={`text-[10px] font-bold mt-1 ${activeTab === item.id ? 'opacity-100' : 'opacity-0'}`}>{item.label}</span>}
            </button>
          ))}
        </div>
      </div>

      {/* ูุงูุฐุฉ ุชูุงุตูู ุงูุฏูุงุก (Modal) */}
      {selectedDrug && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
            <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white relative">
              <button 
                onClick={() => setSelectedDrug(null)}
                className="absolute top-4 left-4 p-2 bg-white/20 rounded-full hover:bg-white/30 transition text-white"
              >
                <X size={20} />
              </button>
              <h2 className="text-2xl font-bold mb-1">{selectedDrug.name}</h2>
              <p className="opacity-90 font-mono text-sm">{selectedDrug.generic}</p>
            </div>
            
            <div className="p-6 space-y-5">
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">ุงูุงุณุชุฎุฏุงู</label>
                <div className="text-slate-800 font-semibold text-lg leading-relaxed">
                  {selectedDrug.use}
                </div>
              </div>
              
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">ุงูุฌุฑุนุฉ ุงููุนุชุงุฏุฉ</label>
                <div className="inline-block bg-indigo-50 text-indigo-700 px-4 py-2 rounded-xl font-bold border border-indigo-100">
                  {selectedDrug.dose}
                </div>
              </div>

              <div className="bg-amber-50 border-r-4 border-amber-500 p-4 rounded-r-lg">
                <div className="flex gap-2 text-amber-800 font-bold mb-1">
                  <AlertTriangle size={18} /> ุชุญุฐูุฑ
                </div>
                <p className="text-sm text-amber-700 leading-relaxed">
                  {selectedDrug.warn}
                </p>
              </div>
            </div>

            <div className="p-4 bg-slate-50 border-t border-slate-100 text-center">
              <button 
                onClick={() => setSelectedDrug(null)}
                className="w-full py-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-600 hover:bg-slate-100 transition"
              >
                ุฅุบูุงู
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
