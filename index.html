import React, { useState, useEffect, useMemo } from 'react';
import { 
  Search, Pill, GraduationCap, HeartPulse, Microscope, Calculator, 
  Syringe, StickyNote, Save, ChevronLeft, AlertTriangle, Baby, 
  Weight, Calendar, X, Stethoscope, Activity, Droplets, Thermometer
} from 'lucide-react';

// --- البيانات (Database) ---
const DRUG_DB = [
  { name: "Panadol / Abimol", generic: "Paracetamol", use: "مسكن ومضاد للحرارة (آمن للحوامل)", dose: "500mg / 6-8hr", warn: "Max 4g/day", type: "otc" },
  { name: "Cataflam / Voltaren", generic: "Diclofenac", use: "مسكن ومضاد التهاب (عظام/أسنان)", dose: "50mg / 8-12hr", warn: "ممنوع لمرضى القرحة والكلى", type: "nsaid" },
  { name: "Brufen", generic: "Ibuprofen", use: "مسكن وخافض حرارة للأطفال", dose: "400mg / 8hr", warn: "بعد الأكل", type: "nsaid" },
  { name: "Augmentin", generic: "Amox+Clav", use: "مضاد حيوي واسع المجال", dose: "1g / 12hr", warn: "حساسية البنسلين", type: "antibiotic" },
  { name: "Zithromax", generic: "Azithromycin", use: "مضاد حيوي (تنفسي)", dose: "500mg daily (3 days)", warn: "قبل الأكل بساعة", type: "antibiotic" },
  { name: "Flagyl", generic: "Metronidazole", use: "مطهر معوي (إسهال)", dose: "500mg / 8hr", warn: "طعم معدني بالفم", type: "antibiotic" },
  { name: "Antodine", generic: "Famotidine", use: "للحموضة", dose: "40mg مساءً", warn: "آمن", type: "git" },
  { name: "Controloc", generic: "Pantoprazole", use: "لقرحة المعدة", dose: "40mg قبل الفطار", warn: "آمن", type: "git" },
  { name: "Visceralgine", generic: "Tiemonium", use: "للمغص والتقلصات", dose: "عند اللزوم", warn: "جفاف بالفم", type: "spasm" },
  { name: "Lasix", generic: "Furosemide", use: "مدر للبول", dose: "40mg صباحاً", warn: "نقص بوتاسيوم", type: "cvs" },
  { name: "Capoten", generic: "Captopril", use: "طوارئ الضغط (تحت اللسان)", dose: "25mg عند اللزوم", warn: "كحة ناشفة", type: "cvs" },
  { name: "Adrenaline", generic: "Epinephrine", use: "إنعاش القلب / حساسية", dose: "Ampoule", warn: "تسارع قلب", type: "emergency" }
];

const TERMINOLOGY = [
  { term: "-itis", meaning: "التهاب (Inflammation)" },
  { term: "Hyper-", meaning: "عالي (High)" },
  { term: "Hypo-", meaning: "منخفض (Low)" },
  { term: "Tachy-", meaning: "سريع (Fast)" },
  { term: "Brady-", meaning: "بطيء (Slow)" }
];

// --- المكونات (Components) ---
const Card = ({ children, className = "", onClick }) => (
  <div onClick={onClick} className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-4 transition-all ${onClick ? 'active:scale-95' : ''} ${className}`}>{children}</div>
);

const Badge = ({ children, type }) => {
  const colors = { otc: "bg-green-100 text-green-700", nsaid: "bg-orange-100 text-orange-700", antibiotic: "bg-blue-100 text-blue-700", emergency: "bg-red-100 text-red-700", git: "bg-yellow-100 text-yellow-700", cvs: "bg-pink-100 text-pink-700", default: "bg-slate-100 text-slate-700" };
  return <span className={`px-2 py-1 rounded-md text-xs font-bold ${colors[type] || colors.default}`}>{children}</span>;
};

// --- التطبيق (Main App) ---
export default function DrBiboApp() {
  const [activeTab, setActiveTab] = useState('home'); 
  const [search, setSearch] = useState('');
  const [selDrug, setSelDrug] = useState(null);
  const [notes, setNotes] = useState(localStorage.getItem('bibo_notes') || '');
  const [msg, setMsg] = useState(false);
  
  // Calculators State
  const [ped, setPed] = useState({ w: '', d: '', c: '', res: null });
  const [bmi, setBmi] = useState({ w: '', h: '', res: null });
  const [edd, setEdd] = useState({ lmp: '', res: null });

  const saveNotes = () => { localStorage.setItem('bibo_notes', notes); setMsg(true); setTimeout(() => setMsg(false), 2000); };

  const filteredDrugs = useMemo(() => DRUG_DB.filter(d => d.name.toLowerCase().includes(search.toLowerCase()) || d.use.includes(search)), [search]);

  useEffect(() => { if (search && activeTab !== 'drugs') setActiveTab('drugs'); }, [search]);

  const renderContent = () => {
    switch (activeTab) {
      case 'drugs': return (
        <div className="space-y-3 pb-24">
          <h2 className="text-xl font-bold text-purple-700 mb-4 flex gap-2"><Pill /> دليل الأدوية</h2>
          {filteredDrugs.map((d, i) => (
            <Card key={i} onClick={() => setSelDrug(d)} className="border-r-4 border-r-purple-500 flex justify-between items-center">
              <div><h3 className="font-bold">{d.name}</h3><p className="text-sm text-slate-500">{d.generic}</p></div>
              <Badge type={d.type}>{d.type}</Badge>
            </Card>
          ))}
        </div>
      );
      case 'study': return (
        <div className="space-y-4 pb-24">
          <h2 className="text-xl font-bold text-blue-700 mb-4 flex gap-2"><GraduationCap /> المرجع الدراسي</h2>
          <Card><h3 className="font-bold mb-2 text-blue-600">مصطلحات طبية</h3>
            {TERMINOLOGY.map((t,i)=><div key={i} className="flex justify-between border-b p-2 last:border-0"><span>{t.meaning}</span><span className="font-bold text-blue-700">{t.term}</span></div>)}
          </Card>
          <Card><h3 className="font-bold mb-2 text-purple-600">اختصارات</h3><div className="grid grid-cols-2 gap-2 text-sm">
            {['OD: مرة','BID: مرتين','TID: 3 مرات','IV: وريد','IM: عضل','PO: فم'].map((x,i)=><div key={i} className="bg-slate-50 p-1 rounded">{x}</div>)}
          </div></Card>
        </div>
      );
      case 'emergency': return (
        <div className="space-y-4 pb-24">
          <h2 className="text-xl font-bold text-red-700 mb-4 flex gap-2"><HeartPulse /> الطوارئ</h2>
          <div className="bg-red-50 p-4 rounded-xl border border-red-100">
            <h3 className="font-bold text-red-700 mb-2">CPR (توقف القلب)</h3>
            <p className="text-sm">1. تأكدي من الأمان والوعي.</p>
            <p className="text-sm">2. اطلبي Code Blue.</p>
            <p className="text-sm font-bold mt-2">معدل الضغط: 100-120/دقيقة</p>
          </div>
          <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
            <h3 className="font-bold text-amber-700 mb-2">Anaphylaxis (حساسية)</h3>
            <ul className="text-sm list-disc list-inside">
              <li>Adrenaline (عضل)</li>
              <li>Avil + Solu-Cortef (وريد)</li>
            </ul>
          </div>
        </div>
      );
      case 'calcs': return (
        <div className="space-y-4 pb-24">
          <h2 className="text-xl font-bold text-indigo-700 mb-4 flex gap-2"><Calculator /> حاسبات</h2>
          <Card>
            <h3 className="font-bold mb-3 flex gap-2"><Baby size={18} /> جرعة أطفال</h3>
            <div className="flex flex-col gap-2">
              <input type="number" placeholder="الوزن (kg)" className="p-2 border rounded" onChange={e=>setPed({...ped,w:e.target.value})}/>
              <div className="flex gap-2">
                <input type="number" placeholder="الجرعة" className="p-2 border rounded w-1/2" onChange={e=>setPed({...ped,d:e.target.value})}/>
                <input type="number" placeholder="التركيز" className="p-2 border rounded w-1/2" onChange={e=>setPed({...ped,c:e.target.value})}/>
              </div>
              <button onClick={()=>{ const r=(ped.w*ped.d*5)/ped.c; setPed({...ped,res:r?r.toFixed(1):0})}} className="bg-indigo-600 text-white p-2 rounded font-bold">احسب</button>
              {ped.res && <div className="text-center font-bold text-green-600 bg-green-50 p-2 rounded">{ped.res} cm</div>}
            </div>
          </Card>
          <Card>
            <h3 className="font-bold mb-3 flex gap-2"><Calendar size={18} /> موعد الولادة</h3>
            <input type="date" className="w-full p-2 border rounded mb-2" onChange={e=>setEdd({...edd,lmp:e.target.value})}/>
            <button onClick={()=>{const d=new Date(edd.lmp); d.setDate(d.getDate()+7); d.setMonth(d.getMonth()+9); setEdd({...edd,res:d.toLocaleDateString('ar-EG')})}} className="bg-amber-500 text-white w-full p-2 rounded font-bold">احسب</button>
            {edd.res && <div className="text-center font-bold mt-2">{edd.res}</div>}
          </Card>
        </div>
      );
      case 'notes': return (
        <div className="space-y-4 pb-24">
          <h2 className="text-xl font-bold text-slate-700 mb-4 flex gap-2"><StickyNote /> نوت بوك</h2>
          <textarea className="w-full h-60 p-4 border rounded-xl bg-yellow-50" value={notes} onChange={e=>setNotes(e.target.value)} placeholder="اكتبي هنا..."></textarea>
          <button onClick={saveNotes} className="w-full bg-emerald-600 text-white p-3 rounded-xl font-bold flex justify-center gap-2"><Save /> حفظ</button>
          {msg && <div className="text-center text-green-600 font-bold">تم الحفظ! ✅</div>}
        </div>
      );
      case 'labs': return (
         <div className="space-y-4 pb-24">
            <h2 className="text-xl font-bold text-teal-700 mb-4 flex gap-2"><Microscope /> التحاليل</h2>
            <Card><h3 className="font-bold text-red-500">CBC</h3><div className="grid grid-cols-2 gap-2 text-sm mt-2">{[{k:'Hb',v:'12-16'},{k:'WBCs',v:'4-11k'},{k:'PLT',v:'150-450k'}].map((x,i)=><div key={i} className="bg-slate-50 p-1 text-center border rounded"><b>{x.k}</b>: {x.v}</div>)}</div></Card>
            <Card><h3 className="font-bold text-orange-500">Kidney & Liver</h3><div className="grid grid-cols-2 gap-2 text-sm mt-2">{[{k:'Creat',v:'0.6-1.2'},{k:'Urea',v:'15-45'},{k:'ALT',v:'<40'}].map((x,i)=><div key={i} className="bg-slate-50 p-1 text-center border rounded"><b>{x.k}</b>: {x.v}</div>)}</div></Card>
         </div>
      );
      case 'nursing': return (
        <div className="space-y-4 pb-24">
          <h2 className="text-xl font-bold text-sky-700 mb-4 flex gap-2"><Syringe /> تمريض</h2>
          <Card><h3 className="font-bold mb-2">الكانيولا</h3><div className="grid grid-cols-3 gap-2 text-center text-xs font-bold text-white">{[{c:'bg-yellow-400',t:'24G'},{c:'bg-blue-500',t:'22G'},{c:'bg-pink-500',t:'20G'},{c:'bg-green-500',t:'18G'},{c:'bg-gray-400',t:'16G'}].map((x,i)=><div key={i} className={`${x.c} p-2 rounded shadow`}>{x.t}</div>)}</div></Card>
          <Card><h3 className="font-bold mb-2">المحاليل</h3><div className="space-y-2 text-sm"><div className="bg-sky-50 p-2 rounded"><b>Saline 0.9%:</b> ضغط، عمليات</div><div className="bg-blue-50 p-2 rounded"><b>Glucose 5%:</b> جفاف</div></div></Card>
        </div>
      );
      default: return (
        <div className="grid grid-cols-2 gap-4 pb-24 animate-in zoom-in">
          {[
            {id:'drugs',l:'أدوية',i:Pill,c:'text-purple-600',b:'bg-purple-50'},
            {id:'study',l:'دراسة',i:GraduationCap,c:'text-blue-600',b:'bg-blue-50'},
            {id:'emergency',l:'طوارئ',i:HeartPulse,c:'text-red-600',b:'bg-red-50'},
            {id:'labs',l:'تحاليل',i:Microscope,c:'text-teal-600',b:'bg-teal-50'},
            {id:'calcs',l:'حاسبات',i:Calculator,c:'text-indigo-600',b:'bg-indigo-50'},
            {id:'nursing',l:'تمريض',i:Syringe,c:'text-sky-600',b:'bg-sky-50'},
            {id:'notes',l:'ملاحظاتي',i:StickyNote,c:'text-slate-600',b:'bg-slate-50',f:true},
          ].map((x)=>(
            <div key={x.id} onClick={()=>setActiveTab(x.id)} className={`bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 active:scale-95 transition ${x.f?'col-span-2':''}`}>
              <div className={`p-3 rounded-full ${x.b}`}><x.i size={28} className={x.c}/></div><span className="font-bold text-slate-700">{x.l}</span>
            </div>
          ))}
        </div>
      );
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans dir-rtl pb-20" dir="rtl">
      <div className="bg-gradient-to-br from-purple-700 to-indigo-800 text-white rounded-b-3xl p-6 pt-12 text-center shadow-lg">
        <h1 className="text-2xl font-bold">Dr. Bibo Universe ♾️</h1>
        <p className="text-purple-200 text-sm">أشطر دكتورة في الدنيا ❤️</p>
      </div>
      
      <div className="px-5 -mt-6 relative z-10">
        <div className="bg-white rounded-full shadow-lg flex items-center px-4 py-3">
          <Search className="text-slate-400 ml-2" size={20} />
          <input type="text" placeholder="بحث..." className="flex-1 outline-none text-slate-700" value={search} onChange={e=>setSearch(e.target.value)} />
          {search && <X size={18} className="text-slate-400" onClick={()=>setSearch('')} />}
        </div>
      </div>

      <div className="p-5">
        {activeTab !== 'home' && <button onClick={()=>setActiveTab('home')} className="mb-4 flex items-center text-sm font-bold text-slate-500"><ChevronLeft size={16}/> القائمة الرئيسية</button>}
        {renderContent()}
      </div>

      <div className="fixed bottom-0 w-full bg-white border-t border-slate-100 p-2 flex justify-around shadow-2xl z-50 rounded-t-2xl">
        {[{id:'drugs',i:Pill,l:'أدوية'},{id:'nursing',i:Syringe,l:'تمريض'},{id:'home',i:Stethoscope,l:'الرئيسية',m:true},{id:'calcs',i:Calculator,l:'حاسبة'},{id:'emergency',i:HeartPulse,l:'طوارئ'}].map(x=>
          <button key={x.id} onClick={()=>{setActiveTab(x.id);window.scrollTo(0,0)}} className={`flex flex-col items-center ${x.m?'-mt-8':''} ${activeTab===x.id?'text-purple-600':'text-slate-400'}`}>
            <div className={`${x.m?'bg-purple-600 text-white p-3 rounded-full shadow-lg border-4 border-slate-50':''}`}><x.i size={x.m?28:24}/></div>
            {!x.m && <span className="text-[10px] font-bold">{x.l}</span>}
          </button>
        )}
      </div>

      {selDrug && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden animate-in zoom-in">
            <div className="bg-purple-600 text-white p-4 flex justify-between items-start">
              <div><h2 className="text-xl font-bold">{selDrug.name}</h2><p className="text-sm opacity-80">{selDrug.generic}</p></div>
              <button onClick={()=>setSelDrug(null)} className="bg-white/20 p-1 rounded-full"><X size={20}/></button>
            </div>
            <div className="p-5 space-y-4">
              <div><label className="text-xs font-bold text-slate-400">الاستخدام</label><p className="font-bold text-lg">{selDrug.use}</p></div>
              <div><label className="text-xs font-bold text-slate-400">الجرعة</label><p className="bg-indigo-50 text-indigo-700 p-2 rounded font-bold inline-block">{selDrug.dose}</p></div>
              <div className="bg-amber-50 p-3 rounded border-r-4 border-amber-500"><div className="flex gap-2 text-amber-800 font-bold text-sm"><AlertTriangle size={16}/> تحذير</div><p className="text-sm text-amber-700">{selDrug.warn}</p></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
